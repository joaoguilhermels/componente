# Template: Java Build and Test
# Reusable stage for Maven build, test, and verification

parameters:
  - name: mavenGoals
    type: string
    default: 'clean verify'
  - name: skipTests
    type: boolean
    default: false
  - name: publishTestResults
    type: boolean
    default: true

steps:
  - task: MavenAuthenticate@0
    displayName: 'Authenticate Maven feed'
    inputs:
      artifactsFeeds: 'customer-registry-feed'

  - task: Maven@4
    displayName: 'Maven ${{ parameters.mavenGoals }}'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: '${{ parameters.mavenGoals }}'
      ${{ if eq(parameters.skipTests, true) }}:
        options: '-Drevision=$(Build.BuildNumber) -DskipTests'
      ${{ else }}:
        options: '-Drevision=$(Build.BuildNumber)'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.21'
      publishJUnitResults: ${{ parameters.publishTestResults }}
      testResultsFiles: '**/surefire-reports/TEST-*.xml'

  - ${{ if eq(parameters.publishTestResults, true) }}:
    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Java code coverage'
      inputs:
        summaryFileLocation: '**/jacoco/test/jacocoTestReport.xml'
      condition: succeededOrFailed()
