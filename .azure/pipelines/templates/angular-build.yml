# Template: Angular Build and Test
# Reusable stage for npm install, Jest test, and ng build

parameters:
  - name: runTests
    type: boolean
    default: true
  - name: buildLibrary
    type: boolean
    default: true

steps:
  - task: npmAuthenticate@0
    displayName: 'Authenticate npm feed'
    inputs:
      workingFile: 'frontend/.npmrc'

  - task: Npm@1
    displayName: 'npm ci'
    inputs:
      command: 'ci'
      workingDir: 'frontend'

  - ${{ if eq(parameters.runTests, true) }}:
    - script: |
        cd frontend
        npx jest --projects projects/customer-registry-ui/jest.config.ts projects/example-crm-app/jest.config.ts --ci --coverage --reporters=default --reporters=jest-junit
      displayName: 'Jest tests'
      env:
        JEST_JUNIT_OUTPUT_DIR: '$(System.DefaultWorkingDirectory)/frontend/test-results'

    - task: PublishTestResults@2
      displayName: 'Publish Angular test results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: 'frontend/test-results/junit.xml'
      condition: succeededOrFailed()

    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Angular code coverage'
      inputs:
        summaryFileLocation: 'frontend/coverage/lcov.info'
      condition: succeededOrFailed()

  - ${{ if eq(parameters.buildLibrary, true) }}:
    - script: |
        cd frontend
        npx ng build customer-registry-ui --configuration production
      displayName: 'Build Angular library'
