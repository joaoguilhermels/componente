# Template: Security Scanning
# SpotBugs + FindSecBugs, Semgrep, OWASP Dependency-Check, npm audit, SBOM

parameters:
  - name: failOnHighCvss
    type: number
    default: 7

steps:
  # ── SAST: SpotBugs + FindSecBugs ──
  - task: Maven@4
    displayName: 'SpotBugs + FindSecBugs'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'spotbugs:check'
      options: '-Dspotbugs.threshold=Medium -Dspotbugs.excludeFilterFile=.azure/security/spotbugs-exclude.xml'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.21'
    continueOnError: false

  # ── SAST: Semgrep ──
  # Pin version for reproducible builds; update periodically.
  - script: |
      pip install semgrep==1.56.0
      semgrep scan --config .azure/security/semgrep-rules.yml --config auto --severity WARNING --error --json -o semgrep-results.json .
    displayName: 'Semgrep SAST scan'
    continueOnError: false

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Semgrep results'
    inputs:
      targetPath: 'semgrep-results.json'
      artifactName: 'security-semgrep'
    condition: succeededOrFailed()

  # ── SCA: OWASP Dependency-Check (Java) ──
  - task: Maven@4
    displayName: 'OWASP Dependency-Check'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'org.owasp:dependency-check-maven:check'
      options: '-DfailBuildOnCVSS=${{ parameters.failOnHighCvss }} -DsuppressionFile=.azure/security/owasp-suppressions.xml'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.21'
    continueOnError: false
    retryCountOnTaskFailure: 2

  - task: PublishPipelineArtifact@1
    displayName: 'Publish OWASP DC report'
    inputs:
      targetPath: 'target/dependency-check-report.html'
      artifactName: 'security-owasp-dc'
    condition: succeededOrFailed()

  # ── SCA: npm audit (Angular) ──
  - script: |
      cd frontend
      npm audit --audit-level=high
    displayName: 'npm audit'
    continueOnError: false

  # ── SBOM: CycloneDX ──
  - task: Maven@4
    displayName: 'Generate Java SBOM (CycloneDX)'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'org.cyclonedx:cyclonedx-maven-plugin:makeBom'
      javaHomeOption: 'JDKVersion'
      jdkVersionOption: '1.21'

  - script: |
      cd frontend
      npx @cyclonedx/cdxgen -o ../sbom-frontend.json
    displayName: 'Generate Angular SBOM (cdxgen)'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish SBOMs'
    inputs:
      targetPath: 'target/bom.json'
      artifactName: 'sbom-backend'

  - task: PublishPipelineArtifact@1
    displayName: 'Publish frontend SBOM'
    inputs:
      targetPath: 'sbom-frontend.json'
      artifactName: 'sbom-frontend'
