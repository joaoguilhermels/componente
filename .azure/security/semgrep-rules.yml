# Custom Semgrep rules for Customer Registry
# These supplement the auto-detected rules (--config auto).

rules:
  # ── No hardcoded secrets ──
  - id: no-hardcoded-secrets
    patterns:
      - pattern-either:
          - pattern: |
              $X = "...$SECRET..."
          - pattern: |
              String $X = "...$SECRET..."
    metavariable-regex:
      metavariable: $SECRET
      regex: '(password|secret|token|api[_-]?key|access[_-]?key|private[_-]?key)'
    message: "Potential hardcoded secret in variable '$X'. Use environment variables or a secrets manager."
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"

  # ── No SQL string concatenation ──
  - id: no-sql-concatenation
    patterns:
      - pattern: |
          "SELECT ..." + $INPUT
      - pattern: |
          "INSERT ..." + $INPUT
      - pattern: |
          "UPDATE ..." + $INPUT
      - pattern: |
          "DELETE ..." + $INPUT
    message: "SQL string concatenation detected. Use parameterized queries or JPA criteria API."
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      cwe: "CWE-89: SQL Injection"

  # ── No String.format with SQL keywords ──
  - id: no-sql-string-format
    patterns:
      - pattern-either:
          - pattern: |
              String.format("SELECT ...", ...)
          - pattern: |
              String.format("INSERT ...", ...)
          - pattern: |
              String.format("UPDATE ...", ...)
          - pattern: |
              String.format("DELETE ...", ...)
    message: "String.format with SQL detected. Use parameterized queries or JPA criteria API instead."
    severity: ERROR
    languages: [java]
    metadata:
      category: security
      cwe: "CWE-89: SQL Injection"

  # ── No hardcoded passwords in YAML/properties files ──
  - id: no-hardcoded-password-yaml
    pattern-regex: '(?i)(password|secret|token|api[_-]?key)\s*[:=]\s*["\']?(?![${\s])[a-zA-Z0-9!@#$%^&*()_+]{4,}["\']?'
    paths:
      include:
        - '**/*.yml'
        - '**/*.yaml'
        - '**/*.properties'
      exclude:
        - '**/test/**'
        - '**/.env.example'
        - '**/semgrep-rules.yml'
    message: "Potential hardcoded credential in configuration file. Use environment variable substitution."
    severity: WARNING
    languages: [generic]
    metadata:
      category: security
      cwe: "CWE-798: Use of Hard-coded Credentials"

  # ── No System.out/err in production code ──
  - id: no-system-out
    pattern: System.out.$METHOD(...)
    paths:
      exclude:
        - '**/test/**'
        - '**/example/**'
    message: "Use SLF4J logger instead of System.out."
    severity: WARNING
    languages: [java]

  - id: no-system-err
    pattern: System.err.$METHOD(...)
    paths:
      exclude:
        - '**/test/**'
        - '**/example/**'
    message: "Use SLF4J logger instead of System.err."
    severity: WARNING
    languages: [java]

  # ── No printStackTrace ──
  - id: no-print-stack-trace
    pattern: $EXCEPTION.printStackTrace(...)
    message: "Use SLF4J logger to log exceptions instead of printStackTrace()."
    severity: WARNING
    languages: [java]
    metadata:
      category: best-practice

  # ── No @SuppressWarnings("unchecked") without justification ──
  - id: no-unchecked-suppress
    pattern: |
      @SuppressWarnings("unchecked")
    paths:
      exclude:
        - '**/test/**'
    message: "Avoid @SuppressWarnings(\"unchecked\"). If necessary, add a comment explaining why it is safe."
    severity: WARNING
    languages: [java]
